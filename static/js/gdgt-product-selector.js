var gdgt=gdgt||{};
gdgt.product_selector={version:"1.2",readonly:!1,labels:{display:"Display",displayed:"Displayed",remove:"Delete",removed:"Deleted",invalid_key:"Invalid API key.",no_results:"No results found.",typeahead:"Add a product manually:",typeahead_placeholder:"Start typing..."},displayed_products:[],deleted_products:[],post_tags:[],max_products:10,post_box:jQuery("#gdgt-product-selector"),displayed_list:jQuery("#gdgt-product-selector-displayed-products"),deleted_list:jQuery("#gdgt-product-selector-deleted-products"),tag_box:jQuery("#post_tag"),
is_post_box_active:function(){return null==gdgt.product_selector.post_box||gdgt.product_selector.post_box.hasClass("closed")||!gdgt.product_selector.post_box.is(":visible")?!1:!0},add_event_bubble_handler:function(a,c,b,d){if(jQuery.isFunction(jQuery.fn.on))a.on(c,b,d);else a.delegate(b,c,d)},remove_event_bubble_handler:function(a,c,b,d){jQuery.isFunction(jQuery.fn.off)?a.off(c,b,d):a.undelegate(b,c,d)},create_typeahead:function(){var a=jQuery('<div id="gdgt-product-selector-typeahead" />');"string"===
typeof gdgt.product_selector.labels.typeahead&&a.append(jQuery("<div />").append(jQuery("<label />").attr("for","gdgt-typeahead").text(gdgt.product_selector.labels.typeahead)));var c=jQuery('<input type="search" size="30" autocomplete="on" />').attr("id","gdgt-typeahead");"string"===typeof gdgt.product_selector.labels.typeahead_placeholder&&c.attr("placeholder",gdgt.product_selector.labels.typeahead_placeholder);a.append(c);gdgt.product_selector.post_box.find("div.inside").append(a)},enable_typeahead:function(){var a=
jQuery("#gdgt-product-selector-typeahead");0===a.length&&(gdgt.product_selector.create_typeahead(),a=jQuery("#gdgt-product-selector-typeahead"));a.show();jQuery("#gdgt-typeahead").prop("disabled",!1).autocomplete({appendTo:a,disabled:!1,focus:function(){return!1},minLength:1,open:function(){var a=jQuery.trim(jQuery(this).data("autocomplete").term);if(!("string"!==typeof a||""===a)){var b=jQuery("#gdgt-product-selector-typeahead ul.ui-autocomplete");b.find("li.ui-menu-item").each(function(){var d=
jQuery(this),e=d.data("uiAutocompleteItem");"undefined"===typeof e&&(e=d.data("item.autocomplete"));var f=jQuery.trim(e.label);f===gdgt.product_selector.labels.invalid_key?(d.addClass("gdgt-error-invalid-key"),d.empty(),d.text(gdgt.product_selector.labels.invalid_key)):f===gdgt.product_selector.labels.no_results?(d.addClass("gdgt-no-results"),d.empty(),d.text(gdgt.product_selector.labels.no_results)):(null==e.parent?(e=e.slug,d.addClass("gdgt-product")):(e=e.parent,d.addClass("gdgt-product-instance")),
null!=e&&(-1!==jQuery.inArray(e,gdgt.product_selector.displayed_products)||-1!==jQuery.inArray(e,gdgt.product_selector.deleted_products)?(d.remove(),b.is(":empty")&&b.append(jQuery('<li class="gdgt-no-results" />').text(gdgt.product_selector.labels.no_results))):"string"!==typeof f||""===f||d.find("a").html(f.replace(a,jQuery("<div />").append(jQuery('<span class="searchterm" /></span>').text(a)).html()))))})}},source:function(a,b){var d=jQuery.trim(a.term);""!==d&&jQuery.ajax({url:gdgt.product_selector.search_by_keyword_endpoint+
"?"+jQuery.param({q:d}),dataType:"json",success:function(a){b(jQuery.map(a,function(a){var b={label:a.autocomplete_name,value:a.slug,slug:a.slug,name:a.name};void 0!==a.instances?b.instances=a.instances:void 0!==a.parent&&(b.parent=a.parent);return b}))},statusCode:{401:function(){b([{label:gdgt.product_selector.labels.invalid_key,value:""}])},404:function(){b([{label:gdgt.product_selector.labels.no_results,value:""}])}}})},select:function(a,b){jQuery("#gdgt-typeahead").val("");gdgt.product_selector.add_product(b.item);
return!1}})},enable:function(){gdgt.product_selector.readonly=!1;gdgt.product_selector.displayed_list=jQuery("#gdgt-product-selector-displayed-products");gdgt.product_selector.deleted_list=jQuery("#gdgt-product-selector-deleted-products");gdgt.product_selector.tag_box=jQuery("#post_tag");gdgt.product_selector.enable_displayed_product_list();gdgt.product_selector.enable_deleted_product_list();gdgt.product_selector.enable_refresh_button();gdgt.product_selector.enable_typeahead();gdgt.product_selector.enable_tag_events();
jQuery("#gdgt-product-selector-results").removeClass("disabled")},disable_typeahead:function(){jQuery("#gdgt-product-selector-typeahead").hide();var a=jQuery("#gdgt-typeahead");0!==a.length&&(a.autocomplete("option","disabled",!0),a.prop("disabled",!0))},disable:function(){gdgt.product_selector.readonly=!0;gdgt.product_selector.disable_refresh_button();gdgt.product_selector.disable_typeahead();gdgt.product_selector.disable_tag_events();gdgt.product_selector.disable_displayed_product_list();gdgt.product_selector.disable_deleted_product_list();
jQuery("#gdgt-product-selector-results").addClass("disabled")},create_displayed_list:function(){if(!(null!=gdgt.product_selector.displayed_list&&0<gdgt.product_selector.displayed_list.length)){var a=jQuery("#gdgt-product-selector-results");a.find("#gdgt-product-selector-results-placeholder").remove();a.prepend("<div><h4>"+gdgt.product_selector.labels.displayed+'</h4><ol id="gdgt-product-selector-displayed-products"></ol></div>');gdgt.product_selector.displayed_list=jQuery("#gdgt-product-selector-displayed-products");
gdgt.product_selector.displayed_products=[];gdgt.product_selector.enable_displayed_product_list()}},create_deleted_list:function(){if(!(null!=gdgt.product_selector.deleted_list&&0<gdgt.product_selector.deleted_list.length)){var a=jQuery("#gdgt-product-selector-results");a.find("#gdgt-product-selector-results-placeholder").remove();a.append("<div><h4>"+gdgt.product_selector.labels.removed+'</h4><ul id="gdgt-product-selector-deleted-products"></ul></div>');gdgt.product_selector.deleted_list=jQuery("#gdgt-product-selector-deleted-products");
gdgt.product_selector.deleted_products=[]}},enable_displayed_product_list:function(){null==gdgt.product_selector.displayed_list||0===gdgt.product_selector.displayed_list.length||(gdgt.product_selector.displayed_list.sortable({axis:"y",containment:"parent",cursor:"move",dropOnEmpty:!1,handle:".gdgt-drag-handle",items:"li.gdgt-product",update:gdgt.product_selector.displayed_product_list_onchange}).sortable("enable"),gdgt.product_selector.displayed_list.find("li.gdgt-product").each(function(){var a=
jQuery(this),c=a.find(".gdgt-drag-handle");0!==c.length&&(c.append(jQuery('<span class="gdgt-drag-handle-icon">&#8691;</span>').hide()),c.before(jQuery('<button type="button" class="gdgt-delete-product" />').text(gdgt.product_selector.labels.remove).click(gdgt.product_selector.delete_product_handler).hide()),a.hover(gdgt.product_selector.displayed_product_list_mouseenter,gdgt.product_selector.displayed_product_list_mouseleave))}))},displayed_product_list_mouseenter:function(){var a=jQuery(this);a.find(".gdgt-drag-handle-icon").show();
a.find(".gdgt-delete-product").show()},displayed_product_list_mouseleave:function(){var a=jQuery(this);a.find(".gdgt-drag-handle-icon").hide();a.find(".gdgt-delete-product").hide()},displayed_product_list_onchange:function(){gdgt.product_selector.displayed_list.find("li.gdgt-product").each(function(a){jQuery(this).find("input").each(function(){var c=jQuery(this);if(c.hasClass("gdgt-product-slug")||c.hasClass("gdgt-product-name")||c.hasClass("gdgt-product-parent")||c.hasClass("gdgt-product-instances")){var b=
c.attr("name");c.attr("name",b.substring(0,13)+a+b.substring(b.indexOf("]",13)))}})})},disable_displayed_product_list:function(){null==gdgt.product_selector.displayed_list||0===gdgt.product_selector.displayed_list.length||(gdgt.product_selector.displayed_list.sortable("disable"),gdgt.product_selector.displayed_list.find("li.gdgt-product").each(function(){jQuery(this).find(".gdgt-drag-handle-icon").remove();jQuery(this).find(".gdgt-delete-product").remove()}))},enable_deleted_product_list:function(){null==
gdgt.product_selector.deleted_list||0===gdgt.product_selector.deleted_list.length||gdgt.product_selector.deleted_list.find("li.gdgt-product").each(function(){var a=jQuery(this);a.find("span.gdgt-product-name").after(jQuery('<button type="button" class="gdgt-undelete-product" />').text(gdgt.product_selector.labels.display).click(gdgt.product_selector.undelete_product_handler).hide());a.hover(gdgt.product_selector.deleted_product_list_mouseenter,gdgt.product_selector.deleted_product_list_mouseleave)})},
deleted_product_list_mouseenter:function(){jQuery(this).find(".gdgt-undelete-product").show()},deleted_product_list_mouseleave:function(){jQuery(this).find(".gdgt-undelete-product").hide()},disable_deleted_product_list:function(){null==gdgt.product_selector.deleted_list||0===gdgt.product_selector.deleted_list.length||gdgt.product_selector.deleted_list.find("li.gdgt-product").each(function(){jQuery(this).find(".gdgt-undelete-product").remove()})},add_product:function(a){if(jQuery.isPlainObject(a)&&
!(void 0===a.slug||""===a.slug||void 0===a.name||""===a.name)){if(void 0!==a.parent){if(-1!==jQuery.inArray(a.parent,gdgt.product_selector.displayed_products)||-1!==jQuery.inArray(a.parent,gdgt.product_selector.deleted_products))return}else if(-1!==jQuery.inArray(a.slug,gdgt.product_selector.displayed_products)||-1!==jQuery.inArray(a.slug,gdgt.product_selector.deleted_products))return;if(null==gdgt.product_selector.displayed_list||0===gdgt.product_selector.displayed_list.length)gdgt.product_selector.create_displayed_list(),
gdgt.product_selector.displayed_list=jQuery("#gdgt-product-selector-displayed-products");var c=gdgt.product_selector.displayed_products.length,b=jQuery('<li class="gdgt-product" />');b.append(jQuery('<button type="button" class="gdgt-delete-product" />').text(gdgt.product_selector.labels.remove).click(gdgt.product_selector.delete_product_handler));b.append(jQuery('<span class="gdgt-drag-handle" />').append(jQuery('<span class="gdgt-product-name" />').text(a.name)).append('<span class="gdgt-drag-handle-icon">&#8691;</span>'));
b.append(jQuery('<input type="hidden" class="gdgt-product-slug" name="gdgt-product['+c+'][slug]" />').val(a.slug));b.append(jQuery('<input type="hidden" class="gdgt-product-name" name="gdgt-product['+c+'][name]" />').val(a.name));if(void 0===a.parent){if(gdgt.product_selector.displayed_products.push(a.slug),void 0!==a.instances){b.append(jQuery('<input type="hidden" class="gdgt-product-instances" name="gdgt-product['+c+'][instances]" />').val(a.instances));var d=jQuery('<ul class="gdgt-product-instances" />');
jQuery.each(a.instances.split(","),function(a,b){d.append(jQuery("<li />").text(jQuery.trim(b)))});d.is(":empty")||b.append(d)}}else gdgt.product_selector.displayed_products.push(a.parent),b.append(jQuery('<input type="hidden" class="gdgt-product-parent" name="gdgt-product['+c+'][parent]" />').val(a.parent));b.hover(gdgt.product_selector.displayed_product_list_mouseenter,gdgt.product_selector.displayed_product_list_mouseleave);gdgt.product_selector.displayed_list.append(b).fadeIn(600);gdgt.product_selector.displayed_list.sortable("refresh")}},
add_deleted_product:function(a){if(jQuery.isPlainObject(a)&&!(void 0===a.slug||""===a.slug||void 0===a.name||""===a.name))if(!(-1!==jQuery.inArray(a.slug,gdgt.product_selector.deleted_products)||-1!==jQuery.inArray(a.slug,gdgt.product_selector.displayed_products))){if(null==gdgt.product_selector.deleted_list||0===gdgt.product_selector.deleted_list.length)gdgt.product_selector.create_deleted_list(),gdgt.product_selector.deleted_list=jQuery("#gdgt-product-selector-deleted-products");var c=gdgt.product_selector.deleted_products.length,
b=jQuery('<li class="gdgt-product" />');b.append(jQuery('<span class="gdgt-product-name" />').text(a.name));b.append(jQuery('<button type="button" class="gdgt-undelete-product" />').text(gdgt.product_selector.labels.display).click(gdgt.product_selector.undelete_product_handler));b.append(jQuery('<input type="hidden" class="gdgt-product-slug" name="gdgt-product-deleted['+c+'][slug]" />').val(a.slug));b.append(jQuery('<input type="hidden" class="gdgt-product-name" name="gdgt-product-deleted['+c+'][name]" />').val(a.name));
if(void 0!==a.instances){b.append(jQuery('<input type="hidden" class="gdgt-product-instances" name="gdgt-product-deleted['+c+'][instances]" />').val(a.instances));var d=jQuery('<ul class="gdgt-product-instances" />');jQuery.each(a.instances.split(","),function(a,b){d.append(jQuery("<li />").text(jQuery.trim(b)))});d.is(":empty")||b.append(d)}b.hover(gdgt.product_selector.deleted_product_list_mouseenter,gdgt.product_selector.deleted_product_list_mouseleave);gdgt.product_selector.deleted_list.append(b).fadeIn(600);
gdgt.product_selector.deleted_products.push(a.slug)}},delete_product_handler:function(){var a=jQuery(this).closest("li.gdgt-product"),c={slug:a.find("input.gdgt-product-slug").val(),name:a.find("input.gdgt-product-name").val()};if(!(null==c.slug||""===c.slug||null==c.name||""===c.name)){var b=-1,d=jQuery.trim(a.find("input.gdgt-product-parent").val());"string"===typeof d&&""!==d?b=jQuery.inArray(d,gdgt.product_selector.displayed_products):(d="",b=jQuery.inArray(c.slug,gdgt.product_selector.displayed_products));
-1!==b&&gdgt.product_selector.displayed_products.splice(b,1);""!==d?a.remove():(b=jQuery.trim(a.find("input.gdgt-product-instances").val()),"string"===typeof b&&""!==b&&(c.instances=b),a.remove(),gdgt.product_selector.add_deleted_product(c));0===gdgt.product_selector.displayed_products.length?(gdgt.product_selector.displayed_list.parent().remove(),gdgt.product_selector.displayed_list=null):gdgt.product_selector.displayed_product_list_onchange()}},undelete_product_handler:function(){var a=jQuery(this).closest("li.gdgt-product"),
c={slug:a.find("input.gdgt-product-slug").val(),name:a.find("input.gdgt-product-name").val()};if(!(null==c.slug||""===c.slug||null==c.name||""===c.name)){var b=jQuery.trim(a.find("input.gdgt-product-instances").val());"string"===typeof b&&""!==b&&(c.instances=b);b=jQuery.inArray(c.slug,gdgt.product_selector.deleted_products);-1!==b&&gdgt.product_selector.deleted_products.splice(b,1);a.remove();gdgt.product_selector.add_product(c);0===gdgt.product_selector.deleted_products.length&&(gdgt.product_selector.deleted_list.parent().remove(),
gdgt.product_selector.deleted_list=null)}},disable_module_handler:function(){jQuery(this).prop("checked")?gdgt.product_selector.disable():(gdgt.product_selector.enable(),0!==gdgt.product_selector.tag_box.length&&gdgt.product_selector.tag_search())},create_refresh_button:function(){gdgt.product_selector.post_box.find("div.inside").prepend(jQuery('<span id="gdgt-refresh-container" />').append(jQuery('<button type="button" />').attr("id","gdgt-refresh").text("\u21ba")))},enable_refresh_button:function(){var a=
jQuery("#gdgt-refresh-container");0===a.length&&(gdgt.product_selector.create_refresh_button(),a=jQuery("#gdgt-refresh-container"));a.show();a=a.find("#gdgt-refresh");0<a.length&&(a.click(gdgt.product_selector.refresh_button_handler),a.trigger("click"))},disable_refresh_button:function(){var a=jQuery("#gdgt-refresh-container");if(0!==a.length){var c=a.find("#gdgt-refresh");0<c.length&&c.unbind("click",gdgt.product_selector.refresh_button_handler);a.hide()}},refresh_button_handler:function(){var a=
"",c="";jQuery.isPlainObject(gdgt.product_selector.loading_spinner_image)&&(null!=gdgt.product_selector.loading_spinner_image.url&&null!=gdgt.product_selector.loading_spinner_image.width&&null!=gdgt.product_selector.loading_spinner_image.height)&&(a=jQuery("#gdgt-refresh-container"),0<a.length&&(c=a.find("#gdgt-refresh"),0<c.length&&c.hide(),a.append(jQuery('<img alt="Loading..." />').attr("src",gdgt.product_selector.loading_spinner_image.url).attr("width",gdgt.product_selector.loading_spinner_image.width).attr("height",
gdgt.product_selector.loading_spinner_image.height))));gdgt.product_selector.refresh_stored_tags();gdgt.product_selector.tag_search();0<a.length&&(a.find("img").remove(),0<c.length&&c.show())},refresh_stored_tags:function(){var a=gdgt.product_selector.tag_box.find(".tagchecklist");0!==a.length&&(gdgt.product_selector.post_tags=[],a.find("span").each(function(){tag=gdgt.product_selector.extract_tag_from_checklist(jQuery(this),jQuery(this).find(".ntdelbutton"));"string"===typeof tag&&""!==tag&&gdgt.product_selector.post_tags.push(tag)}),
gdgt.product_selector.post_tags.sort())},enable_tag_events:function(){if(!(0===gdgt.product_selector.tag_box.length||null==gdgt.product_selector.search_by_tag_endpoint)){var a=gdgt.product_selector.tag_box.find(".tagchecklist");0<a.length&&(gdgt.product_selector.refresh_stored_tags(),gdgt.product_selector.add_event_bubble_handler(a,"click",".ntdelbutton",gdgt.product_selector.delete_tag_handler));gdgt.product_selector.tag_box.find("#new-tag-post_tag").parent().find(".tagadd").click(gdgt.product_selector.add_tags_handler)}},
disable_tag_events:function(){if(0!==gdgt.product_selector.tag_box.length){gdgt.product_selector.tag_box.find(".ajaxtag .tagadd").unbind("click",gdgt.product_selector.add_tags_handler);var a=gdgt.product_selector.tag_box.find(".tagchecklist");0<a.length&&gdgt.product_selector.remove_event_bubble_handler(a,"click",".ntdelbutton",gdgt.product_selector.delete_tag_handler)}},extract_tag_from_checklist:function(a,c){var b=jQuery.trim(c.text()),d=jQuery.trim(a.text());if(!("string"!==typeof d||""===d)&&
"string"===typeof b&&""!==b&&d.substring(0,b.length)==b)return jQuery.trim(d.substring(b.length+1))},add_tags_handler:function(){if(gdgt.product_selector.is_post_box_active()){var a=gdgt.product_selector.post_tags;gdgt.product_selector.refresh_stored_tags();a.length!==gdgt.product_selector.post_tags.length?gdgt.product_selector.tag_search():jQuery.each(a,function(a,b){b!==gdgt.product_selector.post_tags[a]&&gdgt.product_selector.tag_search()})}},delete_tag_handler:function(){if(gdgt.product_selector.is_post_box_active()){var a=
gdgt.product_selector.extract_tag_from_checklist(jQuery(this).parent(),jQuery(this));"string"!==typeof a||""===a||(a=jQuery.inArray(a,gdgt.product_selector.post_tags),-1!==a&&gdgt.product_selector.post_tags.splice(a,1))}},tag_search:function(){!gdgt.product_selector.readonly&&!(null==gdgt.product_selector.post_tags||!jQuery.isArray(gdgt.product_selector.post_tags)||0===gdgt.product_selector.post_tags.length||null==gdgt.product_selector.search_by_tag_endpoint)&&jQuery.getJSON(gdgt.product_selector.search_by_tag_endpoint+
"?"+jQuery.param({tags:gdgt.product_selector.post_tags.join()}),function(a){jQuery.each(a,function(a,b){null!=b.slug&&null!=b.name&&gdgt.product_selector.add_product(b)})})}};
jQuery(function(){gdgt.product_selector.post_box=jQuery("#gdgt-product-selector");if(0!==gdgt.product_selector.post_box.length){gdgt.product_selector.post_box.trigger("gdgt-product-selector-onload");null!=gdgt.product_selector&&!0!==gdgt.product_selector.readonly&&gdgt.product_selector.enable();var a=gdgt.product_selector.post_box.find("#gdgt-products-readonly");0<a.length&&a.click(gdgt.product_selector.disable_module_handler)}});